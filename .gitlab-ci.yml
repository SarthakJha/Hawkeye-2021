# This file is a template, and might need editing before it works on your project.
# Build a Docker image with CI/CD and push to the GitLab registry.
# Docker-in-Docker documentation: https://docs.gitlab.com/ee/ci/docker/using_docker_build.html
#
# This template uses one generic job with conditional builds
# for the default branch and all other (MR) branches.
stages:
  - build
  - deploy

build client:
  # Use the official docker image.
  image: docker:latest
  stage: build
  only:
    # - prod
    changes:
      - client/**/*

  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" registry.gitlab.com
  script:
    - cd client && docker build --pull -t "$CI_REGISTRY_IMAGE"/Hawk-client:latest .
    - docker push "$CI_REGISTRY_IMAGE"/Hawk-client:latest

  # Run this job in a branch where a Dockerfile exists
#   rules:
#     - if: $CI_COMMIT_BRANCH
#       exists:
#         - Dockerfile

build api:
  # Use the official docker image.
  image: docker:latest
  stage: build
  only:
    # branch:
    #   - prod
    changes:
      - api/**/*

  # services:
  #   - docker:dind
  # before_script:
    # - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" registry.gitlab.com
  script:
    - echo $CI_REGISTRY_USER
    - echo $CI_REGISTRY_PASSWORD
  #   - cd client && docker build --pull -t "$CI_REGISTRY_IMAGE"/Hawk-api:latest .
  #   - docker push "$CI_REGISTRY_IMAGE"/Hawk-api:latest
