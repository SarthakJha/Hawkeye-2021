# This file is a template, and might need editing before it works on your project.
# Build a Docker image with CI/CD and push to the GitLab registry.
# Docker-in-Docker documentation: https://docs.gitlab.com/ee/ci/docker/using_docker_build.html
#
# This template uses one generic job with conditional builds
# for the default branch and all other (MR) branches.
stages:
  - build
  - deploy

# test-build:
#   tags: 
#     - docker
#   stage: build
#   image: tmaier/docker-compose:latest
#   services:
#     - docker:dind
#   script:
#     - docker ps
#     - docker-compose -f docker/docker-compose.prod.yml down

build client:
  # Use the official docker image
  image: tmaier/docker-compose:latest
  tags: 
    - docker
  stage: build
  only:
    changes:
      - client/**/*

  services:
    - docker:dind

  before_script:
    - docker login -u "$CI_REG_USERNAME" -p "$CI_REG_TOKEN" $CI_REGISTRY

  script:
    - cd client && docker build -t $CI_REGISTRY/iecse-manipal/board-20/prometheus-21/hawkeye-2021/hawk-client:latest -f client.prod.Dockerfile .
    - docker push $CI_REGISTRY/iecse-manipal/board-20/prometheus-21/hawkeye-2021/hawk-client:latest

  after_script:
    - docker logout $CI_REGISTRY

build api:
  # Use the official docker image.
  image: tmaier/docker-compose:latest
  tags: 
    - docker
  stage: build
  only:
    changes:
      - api/**/*

  services:
    - docker:dind

  before_script:
    - docker login -u "$CI_REG_USERNAME" -p "$CI_REG_TOKEN" $CI_REGISTRY
  script:
    - cd api && docker build -t $CI_REGISTERY/iecse-manipal/board-20/prometheus-21/hawkeye-2021/hawk-api:latest -f api.prod.Dockerfile .
    - docker push $CI_REGISTERY/iecse-manipal/board-20/prometheus-21/hawkeye-2021/hawk-api

deploy-api: 
  stage: deploy
  only:
    changes:
      - api/**/*
  tags:
    - shell
  script:
    - ./deploy/api-deploy.yml

deploy-client: 
  stage: deploy
  only:
    changes:
      - client/**/*
  tags:
    - shell
  script:
    - ./deploy/client-deploy.yml


